name: Publish

on:
  push:
    tags:
      - 'v*.*.*'

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
    inputs:
      dist-tag:
        description: 'npm dist-tag'
        required: true
        default: 'prerelease'
        type: choice
        options:
          - prerelease
          - nightly
      version:
        description: 'Base version for nightly (e.g. 2.0.0). Ignored for prerelease.'
        required: false
        type: string

env:
  NODE_OPTIONS: --max_old_space_size=16384

permissions:
  id-token: write # Required for OIDC
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6
        with:
          # pulls all commits (needed for lerna / semantic release to correctly version)
          fetch-depth: '0'

      - name: Cache build setup
        uses: actions/cache@v5
        with:
          path: node_modules/.cache
          key: ${{ runner.os }}-cache-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-cache-

      - name: Use Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: .nvmrc
          check-latest: true
          cache: 'npm'
          registry-url: 'https://registry.npmjs.org'
      - name: Update npm
        run: npm install -g npm@latest
      - run: npm -v
      - run: npm install

      - name: Authenticate with Registry
        run: |
          echo "@umbraco-ui:registry=https://registry.npmjs.org/" > .npmrc
          echo "registry=https://registry.npmjs.org/" >> .npmrc
          echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" >> .npmrc
          npm whoami
        env:
          NPM_TOKEN: ${{ secrets.UMBRACO_PUBLISH_NPM_TOKEN}}

      - name: Stamp nightly version
        if: inputs.dist-tag == 'nightly' && inputs.version != ''
        run: |
          NIGHTLY_VERSION="${{ inputs.version }}-nightly.$(date +%Y%m%d)"
          echo "Publishing nightly version: $NIGHTLY_VERSION"
          npx lerna version "$NIGHTLY_VERSION" --no-git-tag-version --no-push --yes --force-publish

      - name: Publish package
        run: npm run build && npm whoami && lerna publish from-package --yes --pre-dist-tag ${{ inputs.dist-tag || 'prerelease' }}
        env:
          NPM_TOKEN: ${{ secrets.UMBRACO_PUBLISH_NPM_TOKEN}}
          NPM_CONFIG_PROVENANCE: true

      - name: Update SonarCloud new code baseline
        if: ${{ secrets.SONARCLOUD_TOKEN != '' }}
        run: |
          curl -s -X POST 'https://sonarcloud.io/api/settings/set' \
            -H "Authorization: Bearer ${{ secrets.SONARCLOUD_TOKEN }}" \
            -d 'component=${{ vars.SONARCLOUD_PROJECT_KEY }}&key=sonar.leak.period&value=previous_version'
          curl -s -X POST 'https://sonarcloud.io/api/settings/set' \
            -H "Authorization: Bearer ${{ secrets.SONARCLOUD_TOKEN }}" \
            -d 'component=${{ vars.SONARCLOUD_PROJECT_KEY }}&key=sonar.leak.period.type&value=previous_version'
