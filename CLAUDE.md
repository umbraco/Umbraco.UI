# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## What is this?

Umbraco.UI (UUI) is a web component library built with **Lit** and **TypeScript**. It provides 90+ reusable UI components (`<uui-button>`, `<uui-input>`, `<uui-table>`, etc.) consumed by the Umbraco CMS backoffice via npm packages (`@umbraco-ui/*`).

## Common Commands

```bash
# Install dependencies (also runs bootstrap + generates per-package tsconfigs)
npm install

# Development — starts Storybook on port 6006
npm run storybook

# Build all packages (builds uui-css first, then all others via Turbo)
npm run build

# Full clean + build
npm run build:prod

# Run all tests with coverage
npm run test

# Watch mode for tests
npm run test:watch

# Test a single package (use folder name, e.g. "uui-button")
npm run test:coverage-for uui-button

# Lint
npm run lint

# Auto-fix lint + format
npm run format

# Scaffold a new component (interactive prompts)
npm run new-package
```

## Branching Model

- **`main`** — primary development branch, PR target
- **`production`** — published snapshot, serves Storybook at uui.umbraco.com
- **`release/*`** — intermediary releases (RCs)

## Monorepo Structure

This is an npm workspaces monorepo orchestrated by **Turbo** (build) and **Lerna-Lite** (versioning/publishing).

```
packages/
├── uui-base/          # Foundation: mixins, events, types, registration utilities
├── uui-css/           # Design system CSS custom properties (must build first)
├── uui/               # Bundle package — re-exports all components
├── uui-button/        # Individual component packages (90+)
├── uui-input/
└── ...
```

### Package dependency chain

`uui-css` → `uui-base` → individual components → `uui` (bundle)

Every component depends on `@umbraco-ui/uui-base`. Some depend on sibling components. The `uui` bundle re-exports everything.

### Build orchestration

- **uui-css** is always built first (via Lerna scope) because Storybook and other packages depend on its output. It's also built during `postinstall`/`bootstrap` so it's available immediately after `npm install`.
- **Turbo** then builds all remaining packages in parallel, respecting the dependency graph (`dependsOn: ["^build"]`).
- Per-package **tsconfig.json** files are currently auto-generated by the `bootstrap` script (runs on `postinstall`). Ideally these should be checked in so TypeScript/IDE support works immediately after cloning without needing `npm install` first.

### Versioning & publishing

- All packages share a **single version number** (lockstep via `forcePublish: true` in `lerna.json`). A release bumps all ~90 packages together.
- Conventional commits drive changelog generation.
- Publishing happens from CI on `v*` tags via `lerna publish from-package`.

### Local testing with the backoffice

The backoffice consumes UUI via published npm packages. To test local changes before publishing:

```bash
npm run pack-all          # Build + pack all packages as tarballs
npm run pack-all-no-build # Pack without rebuilding (if already built)
npm run pack              # Pack a single package
```

Install the resulting `.tgz` files in the consuming project.

## Component Architecture

### File structure per package

```
packages/uui-{name}/
├── lib/
│   ├── index.ts                    # Public exports
│   ├── uui-{name}.element.ts      # Component class
│   ├── uui-{name}.test.ts         # Tests
│   └── uui-{name}.story.ts        # Storybook story
├── package.json
├── rollup.config.js                # Imports shared config from packages/rollup-package.config.mjs
└── tsconfig.json                   # Auto-generated by bootstrap
```

### Key patterns

**Mixin composition** — components compose behavior via mixins from `uui-base`:

```typescript
export class UUIButtonElement extends UUIFormControlMixin(
  LabelMixin('', PopoverTargetMixin(LitElement))
) { ... }
```

**Element registration** — use `@defineElement` decorator (not `customElements.define`):

```typescript
import { defineElement } from '@umbraco-ui/uui-base/lib/registration';

@defineElement('uui-button')
export class UUIButtonElement extends ... { }
```

**Events** — custom events extend `UUIEvent` from `uui-base` for type safety.

**CSS custom properties** — components expose styling via `--uui-*` variables.

**Shadow DOM** — all components use shadow DOM for encapsulation.

### Component rules (from CONTRIBUTING.md)

- Element name prefixed with `uui-`, class named `UUI{PascalCase}Element`
- Attribute reflection only for styling, not state
- No external dependencies without HQ approval
- No tag name assumptions — use `:host` or `this`
- JSDoc all properties, slots, events, and CSS custom properties
- Tests must pass, including basic accessibility tests
- Must have a Storybook story

## Build System

- **TypeScript** → `tsc --build` (declaration only) → **Rollup** + esbuild (ES2022 output)
- Shared Rollup config: `packages/rollup-package.config.mjs`
- Turbo handles task orchestration and caching (`turbo.json`)
- `uui-css` must build before everything else (handled by the `build` script)

## Testing

- **Web Test Runner** + **@open-wc/testing** (Mocha + Chai)
- Browsers: Chromium, Firefox, WebKit (via Playwright)
- Config: `web-test-runner.config.mjs`
- Tests live alongside components: `uui-{name}.test.ts`
- Accessibility testing via `expect(element).to.be.accessible()`

## Linting & Formatting

- **ESLint** v9 flat config (`eslint.config.mjs`) with `typescript-eslint`, `eslint-plugin-lit`, `eslint-plugin-wc`, Prettier integration
- **Prettier**: single quotes, 2-space indent, `arrowParens: avoid`, `bracketSameLine: true`
- **Pre-commit hook** (Husky + lint-staged): runs ESLint, type-check on `*.element.ts`, Prettier

## Runtime Requirements

- Node >= 22, npm >= 11 (see `.nvmrc` and `engines` in package.json)
- Lit ^2.8.0 (pinned)
- Target: ES2022
